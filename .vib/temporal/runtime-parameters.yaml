useHelmHooks: false
logLevel: info
frontend:
  podSecurityContext:
    fsGroup: 1002
  containerSecurityContext:
    runAsUser: 1002
  containerPorts:
    rpc: 8233
    http: 8243
    membership: 7933
    metrics: 9091
  automountServiceAccountToken: true
  service:
    ports:
      rpc: 18233
      http: 18243
history:
  podSecurityContext:
    fsGroup: 1002
  containerSecurityContext:
    runAsUser: 1002
  containerPorts:
    rpc: 8234
    membership: 7934
    metrics: 9091
matching:
  podSecurityContext:
    fsGroup: 1002
  containerSecurityContext:
    runAsUser: 1002
  containerPorts:
    rpc: 8235
    membership: 7935
    metrics: 9091
worker:
  podSecurityContext:
    fsGroup: 1002
  containerSecurityContext:
    runAsUser: 1002
  containerPorts:
    membership: 7939
    metrics: 9091
metrics:
  enabled: true
  service:
    ports:
      metrics: 9091
defaultInitContainers:
  waitForDB:
    containerSecurityContext:
      runAsUser: 1002
  renderConfig:
    containerSecurityContext:
      runAsUser: 1002
setupDBJob:
  podSecurityContext:
    fsGroup: 1002
  containerSecurityContext:
    runAsUser: 1002
web:
  sidecars:
  - name: envoy
    image: registry.app-catalog.vmware.com/eam/prd/containers/verified/common/minideb-bookworm/envoy:1.35
    imagePullPolicy: IfNotPresent
    securityContext:
      runAsNonRoot: true
      privileged: false
      allowPrivilegeEscalation: false
      capabilities:
        drop: ["ALL"]
      seccompProfile:
        type: "RuntimeDefault"
    args: ["-c", "/etc/envoy/envoy.yaml"]
    ports:
    - name: https
      containerPort: 8443
    volumeMounts:
    - name: envoy-config
      mountPath: /etc/envoy
    - name: envoy-tls-certs
      mountPath: /etc/certs
  extraVolumes:
  - name: envoy-config
    configMap:
      name: "{{ printf \"%s-envoy-config\" (include \"common.names.fullname\" .) }}"
  - name: envoy-tls-certs
    secret:
      secretName: "{{ printf \"%s-tls-crt\" (include \"temporal.web.fullname\" .) }}"
  service:
    extraPorts:
    - name: https
      port: 443
      targetPort: https
      protocol: TCP
extraDeploy:
- |
  apiVersion: v1
  kind: ConfigMap
  metadata:
    name: {{ printf "%s-envoy-config" (include "common.names.fullname" .) }}
    namespace: {{ include "common.names.namespace" . | quote }}
  data:
    envoy.yaml: |
      static_resources:
        listeners:
        - name: listener_0
          address:
            socket_address: { address: 0.0.0.0, port_value: 8443 }
          filter_chains:
          - filters:
            - name: envoy.filters.network.http_connection_manager
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                stat_prefix: ingress_http
                route_config:
                  name: local_route
                  virtual_hosts:
                  - name: app
                    domains: ["*"]
                    routes:
                    - match: { prefix: "/" }
                      route: { cluster: local_service }
                http_filters:
                - name: envoy.filters.http.router
                  typed_config:
                    "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
            transport_socket:
              name: envoy.transport_sockets.tls
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.DownstreamTlsContext
                common_tls_context:
                  tls_certificates:
                    - certificate_chain: { filename: "/etc/certs/tls.crt" }
                      private_key: { filename: "/etc/certs/tls.key" }
        clusters:
        - name: local_service
          connect_timeout: 0.25s
          type: logical_dns
          lb_policy: round_robin
          load_assignment:
            cluster_name: local_service
            endpoints:
            - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: 127.0.0.1
                      port_value: 8080
- |
  {{- $ca := genCA "temporal-web-ca" 365 }}
  {{- $releaseNamespace := include "common.names.namespace" . }}
  {{- $clusterDomain := .Values.clusterDomain }}
  {{- $webServiceName := include "temporal.web.fullname" . }}
  {{- $altNames := list (printf "%s.%s.svc.%s" $webServiceName $releaseNamespace $clusterDomain) $webServiceName "127.0.0.1" "localhost" }}
  {{- $cert := genSignedCert $webServiceName nil $altNames 365 $ca }}
  apiVersion: v1
  kind: Secret
  metadata:
    name: {{ printf "%s-tls-crt" $webServiceName }}
    namespace: {{ $releaseNamespace | quote }}
  type: kubernetes.io/tls
  data:
    tls.crt: {{ $cert.Cert | b64enc }}
    tls.key: {{ $cert.Key | b64enc }}
