advertisedHost: vib.com
auth:
  password: ComplicatedPassword123!4
tls:
  https:
    enabled: true
    autoGenerated: true
  bolt:
    autoGenerated: true
    level: OPTIONAL
containerPorts:
  http: 7475
  https: 7476
  bolt: 7688
resourcesPreset: "medium"
service:
  extraPorts:
    - name: proxy-https
      port: 443
      protocol: TCP
      targetPort: proxy-https
  ports:
    http: 7475
    https: 7476
    bolt: 7688
  type: LoadBalancer
podSecurityContext:
  enabled: true
  fsGroup: 1002
containerSecurityContext:
  enabled: true
  runAsUser: 1002
  runAsGroup: 1002
sidecars:
  - image: registry.app-catalog.vmware.com/eam/prd/containers/verified/common/minideb-bookworm/apache:latest
    name: apache
    securityContext:
      runAsNonRoot: true
      privileged: false
      allowPrivilegeEscalation: false
      capabilities:
        drop: ["ALL"]
      seccompProfile:
        type: "RuntimeDefault"
    ports:
      - name: proxy-https
        containerPort: 8443
    volumeMounts:
      - name: apache-vhosts
        mountPath: /vhosts
    livenessProbe:
      tcpSocket:
        port: proxy-https
    readinessProbe:
      httpGet:
        path: /
        port: proxy-https
        scheme: HTTPS
extraEnvVars:
  - name: NEO4J_BOLT_ADVERTISED_PORT_NUMBER
    value: "443"
  - name: NEO4J_HTTPS_ADVERTISED_PORT_NUMBER
    value: "443"
extraVolumes: |-
  - name: apache-vhosts
    configMap:
      name: {{ printf "%s-apache-config" (include "common.names.fullname" .) }}
extraDeploy:
  - |
    apiVersion: v1
    kind: ConfigMap
    metadata:
      name: {{ printf "%s-apache-config" (include "common.names.fullname" .) }}
    data:
      neo4j-vhost.conf: |-
        <VirtualHost 127.0.0.1:8443 _default_:8443>
          ServerName {{ include "neo4j.host" . }}
          ServerAlias *

          SSLEngine on
          SSLCertificateFile "/opt/bitnami/apache/conf/bitnami/certs/tls.crt"
          SSLCertificateKeyFile "/opt/bitnami/apache/conf/bitnami/certs/tls.key"
          RequestHeader set X-Forwarded-Proto "https"
          RequestHeader set X-Forwarded-Host "{{ include "neo4j.host" . }}"
          ProxyPreserveHost on

          SSLProxyEngine on
          # Allow self-signed backend
          SSLProxyVerify none
          SSLProxyCheckPeerName off
          SSLProxyCheckPeerCN off
          SSLProxyCheckPeerExpire off

          # Redirect WSS traffic to the bolt backend
          RewriteEngine on
          RewriteCond %{HTTP:Upgrade} =websocket [NC]
          RewriteRule ^/?(.*)           wss://localhost:{{ .Values.containerPorts.bolt }}/$1 [P,L]
          # Redirect HTTPS traffic to the https backend
          ProxyPass / https://localhost:{{ .Values.containerPorts.https }}/
          ProxyPassReverse / {{ include "neo4j.host" . }}
        </VirtualHost>
