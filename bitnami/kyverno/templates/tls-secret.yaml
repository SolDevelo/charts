{{- /*
Copyright Broadcom, Inc. All Rights Reserved.
SPDX-License-Identifier: APACHE-2.0
*/}}

{{- if and (and (not .Values.kyverno.tls.existingCASecret) (not .Values.admissionController.tls.existingSecret) (not .Values.cleanupController.tls.existingSecret)) (or (not .Values.kyverno.tls.autoGenerated.enabled) (and .Values.kyverno.tls.autoGenerated.enabled (eq .Values.kyverno.tls.autoGenerated.engine "helm"))) }}
{{- $caSecretName := include "kyverno.tlsCASecretName" . }}
{{- $admControllerSecretName := include "kyverno.admission-controller.tlsSecretName" . }}
{{- $clnControllerSecretName := include "kyverno.cleanup-controller.tlsSecretName" . }}
{{- $caCertValue := "" }}
{{- $caKeyValue := "" }}
{{- $admControllerCertValue := "" }}
{{- $admControllerKeyValue := "" }}
{{- $clnControllerCertValue := "" }}
{{- $clnControllerKeyValue := "" }}
{{- if .Values.kyverno.tls.autoGenerated.enabled }}
  {{- $releaseNamespace := include "common.names.namespace" . }}
  {{- $clusterDomain := .Values.clusterDomain }}
  {{- $loopback := .Values.kyverno.tls.autoGenerated.loopback }}
  {{- $ipAddresses := ternary (list "127.0.0.1") nil $loopback }}
  {{- $extraSANs := .Values.kyverno.tls.autoGenerated.extraSANs | default (list) }}
  {{- $ca := genCA "kyverno-ca" 1024 }}
  {{- $caCertValue = $ca.Cert }}
  {{- $caKeyValue = $ca.Key }}
  {{- /* Admission controller cert generation */ -}}
  {{- $admControllerServiceName := include "kyverno.admission-controller.fullname" . }}
  {{- $admControllerSANs := include "common.certs.sans" (dict "namespace" $releaseNamespace "clusterDomain" $clusterDomain "serviceName" $admControllerServiceName "loopback" $loopback "extraSANs" $extraSANs) | splitList " " | uniq }}
  {{- $admControllerCert := genSignedCert $admControllerServiceName $ipAddresses $admControllerSANs 1024 $ca }}
  {{- $admControllerCertValue = $admControllerCert.Cert }}
  {{- $admControllerKeyValue = $admControllerCert.Key }}
  {{- if .Values.cleanupController.enabled }}
    {{- /* Cleanup controller cert generation */ -}}
    {{- $clnControllerServiceName := include "kyverno.cleanup-controller.fullname" . }}
    {{- $clnControllerAltNames := include "common.certs.sans" (dict "namespace" $releaseNamespace "clusterDomain" $clusterDomain "serviceName" $clnControllerServiceName "loopback" $loopback "extraSANs" $extraSANs) | splitList " " | uniq }}
    {{- $clnControllerCert := genSignedCert $clnControllerServiceName $ipAddresses $clnControllerAltNames 1024 $ca }}
    {{- $clnControllerCertValue = $clnControllerCert.Cert }}
    {{- $clnControllerKeyValue = $clnControllerCert.Key }}
  {{- end }}
{{- else }}
  {{- $caCertValue = required "When tls.autoGenerated.enabled=false you need to provide tls.ca" .Values.kyverno.tls.CACert }}
  {{- $caKeyValue = required "When tls.autoGenerated.enabled=false you need to provide tls.caKey" .Values.kyverno.tls.CAKey }}
  {{- $admControllerCertValue = required "When tls.autoGenerated.enabled=false you need to provide tls.admission.cert" .Values.admissionController.tls.cert }}
  {{- $admControllerKeyValue = required "When tls.autoGenerated.enabled=false you need to provide tls.admission.key" .Values.admissionController.tls.key }}
  {{- $clnControllerCertValue = required "When tls.autoGenerated.enabled=false you need to provide tls.cleanup.cert" .Values.cleanupController.tls.cert }}
  {{- $clnControllerKeyValue = required "When tls.autoGenerated.enabled=false you need to provide tls.cleanup.key" .Values.cleanupController.tls.key }}
{{- end }}
{{- /*
  Kyverno requires a secret with the CA in the form of tls keypair
  Source: https://github.com/kyverno/kyverno/blob/main/charts/kyverno/templates/admission-controller/secret.yaml#L8
  */}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $caSecretName }}
  namespace: {{ include "common.names.namespace" . | quote }}
  labels: {{- include "common.labels.standard" (dict "customLabels" .Values.commonLabels "context" .) | nindent 4 }}
    app.kubernetes.io/part-of: kyverno
  {{- if .Values.commonAnnotations }}
  annotations: {{- include "common.tplvalues.render" (dict "value" .Values.commonAnnotations "context" .) | nindent 4 }}
  {{- end }}
type: kubernetes.io/tls
data:
  tls.crt: {{ include "common.secrets.lookup" (dict "secret" $caSecretName "key" "kyverno.tls.CACert" "defaultValue" $caCertValue "context" .) }}
  tls.key: {{ include "common.secrets.lookup" (dict "secret" $caSecretName "key" "kyverno.tls.CAKey" "defaultValue" $caKeyValue "context" .) }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ $admControllerSecretName }}
  namespace: {{ include "common.names.namespace" . | quote }}
  labels: {{- include "common.labels.standard" (dict "customLabels" .Values.commonLabels "context" .) | nindent 4 }}
    app.kubernetes.io/component: admission-controller
    app.kubernetes.io/part-of: kyverno
  {{- if .Values.commonAnnotations }}
  annotations: {{- include "common.tplvalues.render" (dict "value" .Values.commonAnnotations "context" .) | nindent 4 }}
  {{- end }}
type: kubernetes.io/tls
data:
  tls.crt: {{ include "common.secrets.lookup" (dict "secret" $admControllerSecretName "key" "admissionController.tls.cert" "defaultValue" $admControllerCertValue "context" .) }}
  tls.key: {{ include "common.secrets.lookup" (dict "secret" $admControllerSecretName "key" "admissionController.tls.key" "defaultValue" $admControllerKeyValue "context" .) }}
  ca.crt: {{ include "common.secrets.lookup" (dict "secret" $admControllerSecretName "key" "kyverno.tls.CACert" "defaultValue" $caCertValue "context" .) }}
{{- if .Values.cleanupController.enabled }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ $clnControllerSecretName }}
  namespace: {{ include "common.names.namespace" . | quote }}
  labels: {{- include "common.labels.standard" (dict "customLabels" .Values.commonLabels "context" .) | nindent 4 }}
    app.kubernetes.io/component: cleanup-controller
    app.kubernetes.io/part-of: kyverno
  {{- if .Values.commonAnnotations }}
  annotations: {{- include "common.tplvalues.render" (dict "value" .Values.commonAnnotations "context" .) | nindent 4 }}
  {{- end }}
type: kubernetes.io/tls
data:
  tls.crt: {{ include "common.secrets.lookup" (dict "secret" $clnControllerSecretName "key" "cleanupController.tls.cert" "defaultValue" $clnControllerCertValue "context" .) }}
  tls.key: {{ include "common.secrets.lookup" (dict "secret" $clnControllerSecretName "key" "cleanupController.tls.key" "defaultValue" $clnControllerKeyValue "context" .) }}
  ca.crt: {{ include "common.secrets.lookup" (dict "secret" $clnControllerSecretName "key" "kyverno.tls.CACert" "defaultValue" $caCertValue "context" .) }}
{{- end }}
{{- end }}
