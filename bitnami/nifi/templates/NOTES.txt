CHART NAME: {{ .Chart.Name }}
CHART VERSION: {{ .Chart.Version }}
APP VERSION: {{ .Chart.AppVersion }}

** Please be patient while the chart is being deployed **

{{- if .Values.diagnosticMode.enabled }}
The chart has been deployed in diagnostic mode. All probes have been disabled and the command has been overwritten with:

  command: {{- include "common.tplvalues.render" (dict "value" .Values.diagnosticMode.command "context" $) | nindent 4 }}
  args: {{- include "common.tplvalues.render" (dict "value" .Values.diagnosticMode.args "context" $) | nindent 4 }}

Get the list of pods by executing:

  kubectl get pods --namespace {{ include "common.names.namespace" . | quote }} -l app.kubernetes.io/instance={{ .Release.Name }}

Access the pod you want to debug by executing

  kubectl exec --namespace {{ include "common.names.namespace" . | quote }} -ti <NAME OF THE POD> -- bash

In order to replicate the container startup scripts execute this command:

    /opt/bitnami/nifi/bin/nifi.sh run

{{- else }}

Your NiFi site can be accessed through the following DNS name from within your cluster:

    {{ include "common.names.fullname" . }}.{{ .Release.Namespace }}.svc.{{ .Values.clusterDomain }} (port {{ .Values.service.ports.web }})

To access your NiFi site from outside the cluster follow the steps below:

{{- if .Values.ingress.enabled }}

1. Get the NiFi URL and associate NiFi hostname to your cluster external IP:

   export CLUSTER_IP=$(minikube ip) # On Minikube. Use: `kubectl cluster-info` on others K8s clusters
   echo "NiFi URL: http{{ if .Values.ingress.tls }}s{{ end }}://{{ .Values.ingress.hostname }}/"
   echo "$CLUSTER_IP  {{ .Values.ingress.hostname }}" | sudo tee -a /etc/hosts

{{- else }}
{{- $port := .Values.service.ports.web | toString }}
{{- $protocol := ternary "https" "http" .Values.tls.enabled }}

1. Get the NiFi URL by running these commands:

{{- if contains "NodePort" .Values.service.type }}

   export NODE_PORT=$(kubectl get --namespace {{ .Release.Namespace }} -o jsonpath="{.spec.ports[0].nodePort}" services {{ include "common.names.fullname" . }})
   export NODE_IP=$(kubectl get nodes --namespace {{ .Release.Namespace }} -o jsonpath="{.items[0].status.addresses[0].address}")
   echo "NiFi URL: {{ $protocol }}://$NODE_IP:$NODE_PORT/"

{{- else if contains "LoadBalancer" .Values.service.type }}

  NOTE: It may take a few minutes for the LoadBalancer IP to be available.
        Watch the status with: 'kubectl get svc --namespace {{ .Release.Namespace }} -w {{ include "common.names.fullname" . }}'

   export SERVICE_IP=$(kubectl get svc --namespace {{ .Release.Namespace }} {{ include "common.names.fullname" . }} --template "{{ "{{ range (index .status.loadBalancer.ingress 0) }}{{ . }}{{ end }}" }}")
   echo "NiFi URL: {{ $protocol }}://$SERVICE_IP:{{ .Values.service.ports.web }}/"

{{- if and (not .Values.service.loadBalancerIP) .Values.tls.enabled (not .Values.ingress.enabled) (not .Values.webProxyHosts) (not .Values.tls.existingSecret) (and (include "nifi.tls.createSecret" . ) .Values.tls.autoGenerated.enabled) }}
WARNING: When running securely, it is necessary to provide the list of allowed hosts that NiFi can serve. Otherwise, it won't be remotely accessible. In order to fix this, do one of the following:

  - Provide the list of allowed hostnames using the webProxyHosts value
  - Provide your own TLS certificate (with the list of allowed hosts) using tls.existingSecret
  - Enable ingress by setting ingress.enabled=true
{{- end }}

{{- else if contains "ClusterIP"  .Values.service.type }}

   kubectl port-forward --namespace {{ .Release.Namespace }} svc/{{ include "common.names.fullname" . }} {{ .Values.service.ports.web }}:{{ .Values.service.ports.web }} &
   echo "NiFi URL: {{ $protocol }}://127.0.0.1:{{ .Values.service.ports.web }}/"

{{- end }}
{{- end }}

{{ if .Values.auth.enabled }}
2. Login with the following credentials:

  echo Username: $(kubectl get secret --namespace {{ include "common.names.namespace" . }} {{ include "nifi.auth.secretName" . }} -o jsonpath="{.data.username}" | base64 -d)
  echo Password: $(kubectl get secret --namespace {{ include "common.names.namespace" . }} {{ include "nifi.auth.secretName" . }} -o jsonpath="{.data.password}" | base64 -d)
{{- else if .Values.tls.enabled }}
WARNING: The Single User credential provider was disabled and the secure mode is enabled. Unless you provide a custom security provider in nifi.properties, the NiFi installation will fail to start.
Ensure that `configuration.overrideNifiProperties` contains a valid value for `nifi.security.user.login.identity.provider`. Find more information in the "Authentication" section of the Bitnami NiFi README.md file.
{{- end }}
{{- end }}

{{- include "common.warnings.rollingTag" .Values.image }}
{{- include "common.warnings.rollingTag" .Values.defaultInitContainers.defaultImage }}
{{- include "nifi.validateValues" . }}
{{- include "common.warnings.resources" (dict "sections" (list "" "defaultInitContainers.copyConfig" "defaultInitContainers.renderConfig" "defaultInitContainers.setAuth" "defaultInitContainers.importCA" "defaultInitContainers.volumePermissions") "context" $) }}
{{- include "common.warnings.modifiedImages" (dict "images" (list .Values.image .Values.defaultInitContainers.defaultImage) "context" $) }}
{{- include "common.errors.insecureImages" (dict "images" (list .Values.image .Values.defaultInitContainers.defaultImage) "context" $) }}
